# Cloudflare Tunnel Setup for Dashboard

This directory contains the configuration and setup scripts for exposing the dashboard through a Cloudflare tunnel.

## Overview

Cloudflare tunnels provide a secure way to expose your dashboard to the internet without opening ports on your firewall. This is especially useful for development and testing environments.

## Files

- `tunnel-config.yml` - Cloudflare tunnel configuration
- `setup-tunnel.sh` - Script to create and configure a new tunnel
- `credentials.json` - Tunnel credentials (generated by setup script)
- `README.md` - This documentation

## Quick Start

### 1. Prerequisites

- Cloudflare account
- Domain managed by Cloudflare
- `cloudflared` CLI tool installed

### 2. Setup Tunnel

```bash
cd apps/dashboard
./cloudflare/setup-tunnel.sh
```

This script will:
- Install `cloudflared` if not present
- Create a new Cloudflare tunnel
- Generate credentials file
- Create DNS record for dashboard subdomain
- Update configuration files

### 3. Deploy Dashboard

```bash
./deploy-with-cloudflare.sh
```

This will:
- Build the dashboard
- Start the dashboard server
- Start the Cloudflare tunnel

## Configuration

### Environment Variables

- `DASHBOARD_PORT` - Port for dashboard server (default: 8080)
- `CLOUDFLARE_DOMAIN` - Your domain for Cloudflare tunnel

### Tunnel Configuration

The `tunnel-config.yml` file contains:

```yaml
tunnel: <tunnel-id>
credentials-file: /app/cloudflare/credentials.json

ingress:
  - hostname: dashboard.your-domain.com
    service: http://localhost:8080
    originRequest:
      httpHostHeader: dashboard.your-domain.com
  - service: http_status:404
```

## Docker Deployment

The dashboard can be deployed with Docker Compose:

```bash
docker-compose up dashboard cloudflared
```

This will:
- Build and start the dashboard container
- Start the Cloudflare tunnel container
- Expose the dashboard through the tunnel

## Security

- Tunnels are authenticated using Cloudflare credentials
- No ports need to be opened on your firewall
- Traffic is encrypted through Cloudflare's network
- Access can be controlled through Cloudflare Access rules

## Troubleshooting

### Tunnel Not Starting

1. Check credentials file exists: `ls cloudflare/credentials.json`
2. Verify tunnel ID in config: `cat cloudflare/tunnel-config.yml`
3. Check Cloudflare dashboard for tunnel status

### DNS Not Resolving

1. Verify DNS record was created in Cloudflare dashboard
2. Check domain is properly configured
3. Wait for DNS propagation (up to 24 hours)

### Dashboard Not Accessible

1. Check dashboard is running: `curl http://localhost:8080`
2. Verify tunnel is running: `cloudflared tunnel list`
3. Check tunnel logs for errors

## Monitoring

### Check Tunnel Status

```bash
cloudflared tunnel list
```

### View Tunnel Logs

```bash
cloudflared tunnel --config cloudflare/tunnel-config.yml run --loglevel debug
```

### Test Dashboard Access

```bash
curl -H "Host: dashboard.your-domain.com" https://dashboard.your-domain.com
```

## Advanced Configuration

### Custom Domain

To use a custom domain:

1. Update `tunnel-config.yml` with your domain
2. Create DNS record in Cloudflare dashboard
3. Restart the tunnel

### SSL/TLS

Cloudflare automatically provides SSL/TLS termination. No additional configuration needed.

### Access Control

Configure access rules in Cloudflare dashboard:
1. Go to Access > Applications
2. Add new application
3. Configure authentication rules
4. Apply to dashboard subdomain

## Support

For issues with Cloudflare tunnels, see:
- [Cloudflare Tunnel Documentation](https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/)
- [Cloudflare Community](https://community.cloudflare.com/)
