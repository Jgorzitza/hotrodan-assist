import{R as k,r as g,j as e}from"./index-DZoorY08.js";import{r as gt,c as mt,D as pt}from"./date-range-CLhjUUo2.js";import{u as ht,e as ft,y as xt,c as bt,f as Ct,b as jt}from"./components-CTA1UUXK.js";import{a as St}from"./context-CVB7tZr2.js";import{u as vt}from"./use-index-resource-state-7IuosbnD.js";import{f as ee,n as yt,v as kt,x as Tt,i as Pt,T as d,P as At,b as p,C as j,I as f,d as Ie,B as I,c as N,r as Ot,a as _t}from"./Page-CO1VPtMw.js";import{T as wt}from"./TitleBar-DFMSJ8Yc.js";import{L as _e}from"./Layout-Drv8ZkBJ.js";import{B as ue}from"./Banner-DCanv2aO.js";import{S as D}from"./Select-BzpuXWta.js";import{T as It}from"./Tabs-DcbyKX5H.js";import{I as $}from"./IndexTable-nycHw1tK.js";import{T as Gt}from"./Toast-CZe5Ihba.js";import{M as E}from"./Modal-vYd8S7dQ.js";import{D as z}from"./Divider-DdX0k3iD.js";import{D as Nt}from"./DataTable-DOlFJz1k.js";import"./FormLayout-Cauguaew.js";import"./Checkbox-drAGhQ4I.js";import"./EmptySearchResult-D4D1_l9z.js";import"./AfterInitialMount-C-VclerA.js";import"./Sticky-3Wxpi6V4.js";import"./index-1GQyLQny.js";import"./context-BSKof4BJ.js";import"./context-CdsfRJ3p.js";import"./InlineGrid-Bklo_vep.js";var Ge=function(a){return k.createElement("svg",Object.assign({viewBox:"0 0 20 20"},a),k.createElement("path",{d:"M12.72 13.78a.75.75 0 1 0 1.06-1.06l-2.72-2.72 2.72-2.72a.75.75 0 0 0-1.06-1.06l-2.72 2.72-2.72-2.72a.75.75 0 0 0-1.06 1.06l2.72 2.72-2.72 2.72a.75.75 0 1 0 1.06 1.06l2.72-2.72 2.72 2.72Z"}))};Ge.displayName="XSmallIcon";var Rt={Grid:"Polaris-Grid"},B={Cell:"Polaris-Grid-Cell","Cell-1-column-xs":"Polaris-Grid-Cell--cell_1ColumnXs","Cell-2-column-xs":"Polaris-Grid-Cell--cell_2ColumnXs","Cell-3-column-xs":"Polaris-Grid-Cell--cell_3ColumnXs","Cell-4-column-xs":"Polaris-Grid-Cell--cell_4ColumnXs","Cell-5-column-xs":"Polaris-Grid-Cell--cell_5ColumnXs","Cell-6-column-xs":"Polaris-Grid-Cell--cell_6ColumnXs","Cell-1-column-sm":"Polaris-Grid-Cell--cell_1ColumnSm","Cell-2-column-sm":"Polaris-Grid-Cell--cell_2ColumnSm","Cell-3-column-sm":"Polaris-Grid-Cell--cell_3ColumnSm","Cell-4-column-sm":"Polaris-Grid-Cell--cell_4ColumnSm","Cell-5-column-sm":"Polaris-Grid-Cell--cell_5ColumnSm","Cell-6-column-sm":"Polaris-Grid-Cell--cell_6ColumnSm","Cell-1-column-md":"Polaris-Grid-Cell--cell_1ColumnMd","Cell-2-column-md":"Polaris-Grid-Cell--cell_2ColumnMd","Cell-3-column-md":"Polaris-Grid-Cell--cell_3ColumnMd","Cell-4-column-md":"Polaris-Grid-Cell--cell_4ColumnMd","Cell-5-column-md":"Polaris-Grid-Cell--cell_5ColumnMd","Cell-6-column-md":"Polaris-Grid-Cell--cell_6ColumnMd","Cell-1-column-lg":"Polaris-Grid-Cell--cell_1ColumnLg","Cell-2-column-lg":"Polaris-Grid-Cell--cell_2ColumnLg","Cell-3-column-lg":"Polaris-Grid-Cell--cell_3ColumnLg","Cell-4-column-lg":"Polaris-Grid-Cell--cell_4ColumnLg","Cell-5-column-lg":"Polaris-Grid-Cell--cell_5ColumnLg","Cell-6-column-lg":"Polaris-Grid-Cell--cell_6ColumnLg","Cell-7-column-lg":"Polaris-Grid-Cell--cell_7ColumnLg","Cell-8-column-lg":"Polaris-Grid-Cell--cell_8ColumnLg","Cell-9-column-lg":"Polaris-Grid-Cell--cell_9ColumnLg","Cell-10-column-lg":"Polaris-Grid-Cell--cell_10ColumnLg","Cell-11-column-lg":"Polaris-Grid-Cell--cell_11ColumnLg","Cell-12-column-lg":"Polaris-Grid-Cell--cell_12ColumnLg","Cell-1-column-xl":"Polaris-Grid-Cell--cell_1ColumnXl","Cell-2-column-xl":"Polaris-Grid-Cell--cell_2ColumnXl","Cell-3-column-xl":"Polaris-Grid-Cell--cell_3ColumnXl","Cell-4-column-xl":"Polaris-Grid-Cell--cell_4ColumnXl","Cell-5-column-xl":"Polaris-Grid-Cell--cell_5ColumnXl","Cell-6-column-xl":"Polaris-Grid-Cell--cell_6ColumnXl","Cell-7-column-xl":"Polaris-Grid-Cell--cell_7ColumnXl","Cell-8-column-xl":"Polaris-Grid-Cell--cell_8ColumnXl","Cell-9-column-xl":"Polaris-Grid-Cell--cell_9ColumnXl","Cell-10-column-xl":"Polaris-Grid-Cell--cell_10ColumnXl","Cell-11-column-xl":"Polaris-Grid-Cell--cell_11ColumnXl","Cell-12-column-xl":"Polaris-Grid-Cell--cell_12ColumnXl"};function $t({area:t,column:a,columnSpan:n,row:s,children:i}){const c=ee(B.Cell,(n==null?void 0:n.xs)&&B[`Cell-${n.xs}-column-xs`],(n==null?void 0:n.sm)&&B[`Cell-${n.sm}-column-sm`],(n==null?void 0:n.md)&&B[`Cell-${n.md}-column-md`],(n==null?void 0:n.lg)&&B[`Cell-${n.lg}-column-lg`],(n==null?void 0:n.xl)&&B[`Cell-${n.xl}-column-xl`]),r={gridArea:t,"--pc-column-xs":a==null?void 0:a.xs,"--pc-column-sm":a==null?void 0:a.sm,"--pc-column-md":a==null?void 0:a.md,"--pc-column-lg":a==null?void 0:a.lg,"--pc-column-xl":a==null?void 0:a.xl,"--pc-row-xs":s==null?void 0:s.xs,"--pc-row-sm":s==null?void 0:s.sm,"--pc-row-md":s==null?void 0:s.md,"--pc-row-lg":s==null?void 0:s.lg,"--pc-row-xl":s==null?void 0:s.xl};return k.createElement("div",{className:c,style:r},i)}const _=function({gap:a,areas:n,children:s,columns:i}){const c={"--pc-grid-gap-xs":a==null?void 0:a.xs,"--pc-grid-gap-sm":a==null?void 0:a.sm,"--pc-grid-gap-md":a==null?void 0:a.md,"--pc-grid-gap-lg":a==null?void 0:a.lg,"--pc-grid-gap-xl":a==null?void 0:a.xl,"--pc-grid-columns-xs":i==null?void 0:i.xs,"--pc-grid-columns-sm":i==null?void 0:i.sm,"--pc-grid-columns-md":i==null?void 0:i.md,"--pc-grid-columns-lg":i==null?void 0:i.lg,"--pc-grid-columns-xl":i==null?void 0:i.xl,"--pc-grid-areas-xs":X(n==null?void 0:n.xs),"--pc-grid-areas-sm":X(n==null?void 0:n.sm),"--pc-grid-areas-md":X(n==null?void 0:n.md),"--pc-grid-areas-lg":X(n==null?void 0:n.lg),"--pc-grid-areas-xl":X(n==null?void 0:n.xl)};return k.createElement("div",{className:Rt.Grid,style:c},s)};function X(t){if(t)return`'${t==null?void 0:t.join("' '")}'`}_.Cell=$t;var S={Tag:"Polaris-Tag",disabled:"Polaris-Tag--disabled",clickable:"Polaris-Tag--clickable",linkable:"Polaris-Tag--linkable",removable:"Polaris-Tag--removable",Button:"Polaris-Tag__Button",Link:"Polaris-Tag__Link",segmented:"Polaris-Tag--segmented",Text:"Polaris-Tag__Text",sizeLarge:"Polaris-Tag--sizeLarge",overlay:"Polaris-Tag--overlay"};function Ne({children:t,disabled:a=!1,onClick:n,onRemove:s,accessibilityLabel:i,url:c,size:r}){const u=yt(),x=s&&c,T=ee(S.Tag,a&&S.disabled,n&&S.clickable,s&&S.removable,c&&!a&&S.linkable,x&&S.segmented,r&&S[kt("size",r)]);let v=i;v||(v=typeof t=="string"?t:void 0);const b=k.createElement(d,{as:"span",variant:"bodySm",truncate:!0},k.createElement("span",{title:v,className:S.Text},t));if(n)return k.createElement("button",{type:"button",disabled:a,className:T,onClick:n},b);const R=u.translate("Polaris.Tag.ariaLabel",{children:v||""}),M=s?k.createElement("button",{type:"button","aria-label":R,className:ee(S.Button,x&&S.segmented),onClick:s,onMouseUp:Tt,disabled:a},k.createElement(Pt,{source:Ge})):null,F=c&&!a?k.createElement("a",{className:ee(S.Link,x&&S.segmented),href:c},b):b;return k.createElement("span",{className:T,"aria-disabled":a},F,r==="large"&&k.createElement("span",{className:S.overlay}),M)}const ge=[{id:"all",content:"All"},{id:"unfulfilled",content:"Unfulfilled"},{id:"overdue",content:"Overdue"},{id:"refunded",content:"Refunded"}],me=[{label:"12 / page",value:"12"},{label:"24 / page",value:"24"},{label:"36 / page",value:"36"},{label:"50 / page",value:"50"}],Mt={inventory:"attention",payment:"critical",address:"warning",carrier:"warning",manual_check:"info",none:"success"},Et={paid:"info",processing:"attention",fulfilled:"success",refunded:"info",cancelled:"critical"},Lt={fulfilled:"success",partial:"info",unfulfilled:"attention"},Re={vip:"critical",rush:"warning",standard:"success"};function Ts(){var Pe,Ae,Oe;const{dataset:t,scenario:a,useMockData:n}=ht(),s=ft(),i=xt(),c=bt(),r=Ct(),[u]=jt(),[x,T]=g.useState("assistant"),[v,b]=g.useState(null),[R,M]=g.useState(null),[F,se]=g.useState(!1),[ne,le]=g.useState(""),{mdUp:J}=St(),[ae,xe]=g.useState(t.alerts),[be,Ce]=g.useState(t.dataGaps),je=g.useRef(null),H=g.useRef(null),{orders:P,lookup:Me}=Kt({baseOrders:t.orders.items,submission:s.submission,response:s.data}),Ee=gt(u.get("range"),pt),V=u.get("channel")??"all",W=u.get("assigned_to")??"all",K=u.get("tag")??"all",Le=g.useMemo(()=>mt,[]),De=g.useMemo(()=>[{label:"All channels",value:"all"},{label:"Online",value:"online"},{label:"POS",value:"pos"},{label:"Draft",value:"draft"}],[]),Be=g.useMemo(()=>{const l=new Set;P.forEach(m=>{m.assignedTo&&l.add(m.assignedTo)});const o=Array.from(l).sort((m,C)=>m.localeCompare(C));return[{label:"All owners",value:"all"},...o.map(m=>({label:he(m),value:m})),{label:"Unassigned",value:"unassigned"}].filter((m,C,h)=>h.findIndex(G=>G.value===m.value)===C)},[P]),Se=g.useMemo(()=>{const l=new Set;P.forEach(m=>{m.tags.forEach(C=>{C&&l.add(C)})});const o=Array.from(l).sort((m,C)=>m.localeCompare(C));return[{label:"All tags",value:"all"},...o.map(m=>({label:m,value:m}))]},[P]),ve=g.useMemo(()=>[V!=="all"?{key:"channel",label:`Channel: ${qt(V)}`}:null,W!=="all"?{key:"assigned_to",label:`Owner: ${he(W)}`}:null,K!=="all"?{key:"tag",label:`Tag: ${K}`}:null].filter(Boolean),[V,W,K]),y=g.useCallback(l=>{const o=new URLSearchParams(u);l(o),o.delete("cursor"),o.delete("direction");const m=o.toString();c(m?`${r.pathname}?${m}`:r.pathname,{replace:!0})},[r.pathname,c,u]),Ue=g.useCallback(l=>{y(o=>{o.set("range",l),o.delete("date_start"),o.delete("date_end")})},[y]),Fe=g.useCallback(l=>{y(o=>{l==="all"?o.delete("channel"):o.set("channel",l)})},[y]),He=g.useCallback(l=>{y(o=>{l==="all"?o.delete("assigned_to"):o.set("assigned_to",l)})},[y]),qe=g.useCallback(l=>{y(o=>{l==="all"?o.delete("tag"):o.set("tag",l)})},[y]),Xe=g.useCallback(l=>{y(o=>{o.delete(l)})},[y]),ze=Math.max(ge.findIndex(l=>l.id===t.tab),0),{selectedResources:A,allResourcesSelected:Je,handleSelectionChange:Ve,clearSelection:ye}=vt(P,{resourceIDResolver:l=>l.id}),O=g.useMemo(()=>A.length,[A]),ie=R?Me.get(R)??null:null;g.useEffect(()=>{R&&!ie&&M(null)},[ie,R]);const re=(Pe=s.submission)==null?void 0:Pe.formData.get("intent"),Z=g.useMemo(()=>({intent:typeof re=="string"?re:null,isBusy:s.state!=="idle"}),[s.state,re]),Q=Z.isBusy&&Z.intent==="requestSupport",L=g.useMemo(()=>{if(!A.length)return[];const l=new Map;return P.forEach(o=>{l.set(o.id,o.name)}),A.map(o=>l.get(o)??o)},[P,A]),We=g.useCallback(l=>{y(o=>{o.set("tab",ge[l].id)})},[y]);g.useEffect(()=>{xe(t.alerts),Ce(t.dataGaps)},[t.alerts,t.dataGaps]),g.useEffect(()=>{if(n||typeof window>"u")return;let l=!1;const o=()=>{if(l)return;const m=new EventSource("/sync/orders/alerts");je.current=m,m.onmessage=C=>{try{const h=JSON.parse(C.data??"{}");h!=null&&h.message&&(xe(G=>G.includes(h.message)?G:[h.message,...G]),b({status:typeof h.status=="string"&&h.status.length>0?h.status:"info",message:String(h.message)})),(h==null?void 0:h.type)==="data_gap"&&(h!=null&&h.message)&&Ce(G=>G.includes(h.message)?G:[h.message,...G])}catch(h){console.warn("orders alerts stream parse error",h)}i.revalidate()},m.onerror=()=>{m.close(),!l&&(H.current&&clearTimeout(H.current),H.current=setTimeout(o,5e3))}};return o(),()=>{var m;l=!0,(m=je.current)==null||m.close(),H.current&&clearTimeout(H.current)}},[i,n]),g.useEffect(()=>{if(!s.data)return;const{toast:l,message:o,success:m}=s.data,C=l!=null&&l.message?{status:l.status??(m?"success":"error"),message:l.message}:o?{status:m?"success":"error",message:o}:null;C&&b(C),ye(),i.revalidate()},[s.data,ye,i]);const Ke=t.metrics,w=t.orders.pageInfo,Y=w.nextCursor,oe=w.previousCursor,Ze=w.hasNextPage&&!!Y,Qe=w.hasPreviousPage,q=String(w.pageSize),de=t.orders.count,ce=P.length>0,ke=ce?(Math.max(w.page,1)-1)*w.pageSize+1:0,Ye=ce?Math.min(de,ke+P.length-1):0,et=ce?`${ke}-${Ye} of ${de}`:`0 of ${de}`,tt=`Page ${Math.min(w.page,w.totalPages)} of ${w.totalPages}`,st=g.useMemo(()=>me.some(l=>l.value===q)?me:[...me,{label:`${q} / page`,value:q}],[q]),nt=()=>{O&&s.submit({intent:"assign",orderIds:JSON.stringify(A),assignee:x},{method:"post"})},Te=g.useCallback(()=>{se(!1),le("")},[]),lt=g.useCallback(()=>{if(!O)return;const l=ne.trim(),o=L.slice(0,3).join(", "),m=o?`Follow-up requested for ${o}${L.length>3?` (+${L.length-3} more)`:""}.`:"Follow-up requested from dashboard.";s.submit({intent:"requestSupport",payload:JSON.stringify({orderIds:A,note:l||m})},{method:"post"}),se(!1),le("")},[s,O,L,A,ne]),at=g.useCallback(l=>{const o=new URLSearchParams(u);o.set("pageSize",l),o.delete("cursor"),o.delete("direction"),c(`?${o.toString()}`)},[c,u]),it=g.useCallback(()=>{if(!Y)return;const l=new URLSearchParams(u);l.set("cursor",Y),l.set("direction","after"),c(`?${l.toString()}`)},[c,Y,u]),rt=g.useCallback(()=>{const l=new URLSearchParams(u);oe?(l.set("cursor",oe),l.set("direction","before")):(l.delete("cursor"),l.delete("direction")),c(`?${l.toString()}`)},[c,oe,u]),ot=()=>{if(!O)return;const o=`TRK-${(A[0]??"").slice(-4).toUpperCase()||"0000"}`;s.submit({intent:"markFulfilled",orderIds:JSON.stringify(A),tracking:JSON.stringify({number:o,carrier:"UPS"})},{method:"post"})},dt=g.useCallback(l=>{const o=l.orderId;if(!o){b({status:"error",message:"Unable to add tracking — missing order reference."});return}const h=`TRK-${l.orderNumber.replace(/[^0-9A-Z]/gi,"").slice(-4).padStart(4,"0")||"0000"}`;s.submit({intent:"markFulfilled",orderIds:JSON.stringify([o]),tracking:JSON.stringify({number:h,carrier:"UPS"})},{method:"post"})},[s,b]),ct=g.useCallback(l=>{const o=l.orderId;if(!o){b({status:"error",message:"Unable to request support — missing order reference."});return}const m=`Carrier ${l.carrier??"Unknown"} delayed ${l.delayHours}h (last update ${te(l.lastUpdate)}).`;s.submit({intent:"requestSupport",payload:JSON.stringify({orderIds:[o],note:m})},{method:"post"})},[s,b]),ut=g.useCallback((l,o)=>{if(!l.orderId){b({status:"error",message:"Unable to update return — missing order reference."});return}const m=o==="approve_refund"?"Refund approved from dashboard orders.":o==="request_inspection"?"Inspection requested before refund approval.":"Return denied from dashboard orders.";s.submit({intent:"updateReturn",payload:JSON.stringify({orderId:l.orderId,action:o,note:m})},{method:"post"})},[s,b]);return e.jsxs(At,{title:"Orders",subtitle:"Monitor fulfillment backlog, shipment health, and returns.",children:[e.jsx(wt,{title:"Orders",primaryAction:{content:"Export CSV",url:"#"}}),e.jsx(_e,{children:e.jsx(_e.Section,{children:e.jsxs(p,{gap:"400",children:[(ae.length||be.length||n)&&e.jsxs(p,{gap:"200",children:[n&&e.jsx(ue,{tone:a==="warning"?"warning":"info",title:`Mock state: ${a}`,children:e.jsx("p",{children:"Append `mockState=warning` (etc) to preview additional states."})}),ae.map((l,o)=>e.jsx(ue,{tone:"warning",title:"Fulfillment alert",children:e.jsx("p",{children:l})},`alert-${o}`)),be.map((l,o)=>e.jsx(ue,{tone:"attention",title:"Data gap",children:e.jsx("p",{children:l})},`gap-${o}`))]}),e.jsx(j,{children:e.jsx(j.Section,{children:e.jsxs(p,{gap:"200",children:[e.jsxs(f,{gap:"200",blockAlign:"center",wrap:!0,children:[e.jsx(D,{labelHidden:!0,label:"Date range",options:Le,value:Ee,onChange:Ue}),e.jsx(D,{labelHidden:!0,label:"Channel",options:De,value:V,onChange:Fe}),e.jsx(D,{labelHidden:!0,label:"Owner",options:Be,value:W,onChange:He}),e.jsx(D,{labelHidden:!0,label:"Tag",options:Se,value:K,onChange:qe,disabled:Se.length<=1})]}),e.jsxs(f,{align:"space-between",blockAlign:"center",children:[e.jsx(d,{tone:"subdued",variant:"bodySm",as:"span",children:t.period.label}),ve.length>0&&e.jsx(f,{gap:"100",wrap:!0,children:ve.map(l=>e.jsx(Ne,{onRemove:()=>Xe(l.key),children:l.label},l.key))})]})]})})}),e.jsx(Xt,{metrics:Ke}),e.jsx(j,{children:e.jsxs(p,{gap:"200",children:[e.jsxs(f,{align:"space-between",blockAlign:"center",children:[e.jsx(It,{tabs:ge,selected:ze,onSelect:We,fitted:!0}),e.jsxs(f,{gap:"200",children:[e.jsx(D,{labelHidden:!0,label:"Assign to",options:Dt,value:x,onChange:l=>T(l)}),e.jsxs(Ie,{children:[e.jsx(I,{disabled:!O,onClick:nt,loading:s.state!=="idle"&&((Ae=s.submission)==null?void 0:Ae.formData.get("intent"))==="assign",children:"Assign"}),e.jsx(I,{disabled:!O,onClick:ot,loading:s.state!=="idle"&&((Oe=s.submission)==null?void 0:Oe.formData.get("intent"))==="markFulfilled",children:"Mark fulfilled"}),e.jsx(I,{disabled:!O,onClick:()=>se(!0),loading:Q,children:"Request follow-up"})]})]})]}),e.jsx($,{resourceName:{singular:"order",plural:"orders"},itemCount:P.length,selectedItemsCount:Je?"All":A.length,onSelectionChange:Ve,headings:J?Bt:Ut,children:P.map((l,o)=>e.jsxs($.Row,{id:l.id,position:o,onClick:()=>M(l.id),children:[e.jsx($.Cell,{children:e.jsxs(p,{gap:"050",children:[e.jsx(d,{variant:"bodyMd",fontWeight:"semibold",as:"span",children:l.name}),e.jsxs(f,{gap:"200",blockAlign:"center",children:[e.jsx(N,{tone:Re[l.priority],children:l.priority}),e.jsx(d,{as:"span",tone:"subdued",variant:"bodySm",children:l.customer.name})]})]})}),J&&e.jsx($.Cell,{children:e.jsx(N,{tone:l.issue==="none"?"success":"warning",children:l.issue})}),e.jsx($.Cell,{children:e.jsx(d,{variant:"bodySm",as:"span",children:l.total.formatted})}),J&&e.jsx($.Cell,{children:e.jsx(d,{variant:"bodySm",tone:"subdued",as:"span",children:U(l.shipBy??l.fulfillmentDueAt)})}),e.jsx($.Cell,{children:e.jsxs(d,{variant:"bodySm",as:"span",children:[l.ageHours.toFixed(1),"h ago"]})}),J&&e.jsx($.Cell,{children:e.jsx(d,{variant:"bodySm",tone:"subdued",as:"span",children:l.assignedTo})})]},l.id))}),e.jsxs(f,{align:"space-between",blockAlign:"center",children:[e.jsx(d,{tone:"subdued",variant:"bodySm",as:"span",children:et}),e.jsxs(f,{gap:"200",blockAlign:"center",children:[e.jsx(D,{labelHidden:!0,label:"Rows per page",options:st,value:q,onChange:at}),e.jsx(Ot,{label:tt,hasPrevious:Qe,onPrevious:rt,hasNext:Ze,onNext:it})]})]})]})}),e.jsxs(_,{columns:{xs:1,md:2},gap:"400",children:[e.jsx(_.Cell,{children:e.jsx(zt,{shipments:t.shipments,onAddTracking:dt,onTriggerFollowUp:ct,actionState:Z})}),e.jsx(_.Cell,{children:e.jsx(Jt,{returns:t.returns,onHandleReturn:ut,actionState:Z})})]}),e.jsx(Vt,{inventory:t.inventory,alerts:ae})]})})}),v&&e.jsx(Gt,{content:v.message,duration:3e3,error:v.status==="error",onDismiss:()=>b(null)}),e.jsx(E,{open:F,onClose:Te,title:`Request support${O>1?` (${O})`:""}`,primaryAction:{content:O>1?"Send requests":"Send request",onAction:lt,loading:Q,disabled:!O||Q},secondaryActions:[{content:"Cancel",onAction:Te,disabled:Q}],children:e.jsx(E.Section,{children:e.jsxs(p,{gap:"200",children:[L.length>0&&e.jsxs(d,{tone:"subdued",variant:"bodySm",as:"span",children:["Target orders: ",L.join(", ")]}),e.jsx(_t,{label:"Note for support",value:ne,onChange:le,multiline:4,autoComplete:"off",placeholder:"Include context, blockers, or next steps for support."})]})})}),e.jsx(Wt,{order:ie,onClose:()=>M(null)})]})}const Dt=[{label:"Assistant",value:"assistant"},{label:"Ops team",value:"ops"},{label:"Unassigned",value:"unassigned"}],Bt=[{title:"Order"},{title:"Issue"},{title:"Value"},{title:"Ship by"},{title:"Age"},{title:"Owner"}],Ut=[{title:"Order"},{title:"Value"},{title:"Age"}],U=t=>t?new Intl.DateTimeFormat("en-US",{month:"short",day:"numeric"}).format(new Date(t)):"—",te=t=>t?new Intl.DateTimeFormat("en-US",{month:"short",day:"numeric",hour:"numeric",minute:"2-digit"}).format(new Date(t)):"—",Ft=t=>t.onHand<=0?"critical":t.ordersWaiting>t.onHand?"warning":"attention",Ht=t=>{if(t.onHand<=0)return"No stock on hand — escalate the purchase order or reroute impacted orders.";const a=t.ordersWaiting-t.onHand;return a>0?`${a} unit${a===1?"":"s"} short — split shipments or recommend alternates until restock arrives.`:t.ordersWaiting===0?"Inventory is clear — confirm the block is lifted in fulfillment.":"Sufficient stock to cover waiting orders — coordinate pick/pack to release the hold."},$e=t=>t.split(/[-_\s]+/).filter(Boolean).map(a=>a.charAt(0).toUpperCase()+a.slice(1)).join(" ");function he(t){return t?t==="assistant"?"Assistant":t==="unassigned"?"Unassigned":$e(t):"Unassigned"}function qt(t){switch(t){case"online":return"Online";case"pos":return"POS";case"draft":return"Draft";default:return $e(t)}}function Xt({metrics:t}){const a=[["Total orders",String(t.totalOrders),void 0],["Awaiting fulfillment",String(t.awaitingFulfillment),t.awaitingFulfillment>0?"attention":"success"],["Awaiting tracking",String(t.awaitingTracking),t.awaitingTracking>0?"warning":"success"],["Overdue",`${t.overdue} (${t.overduePercentage.toFixed(0)}%)`,t.overdue>0?"critical":"success"],["Avg fulfillment time",`${t.averageFulfillmentHours.toFixed(1)}h`,void 0],["SLA breaches",String(t.slaBreaches),t.slaBreaches?"critical":"success"]];return e.jsx(j,{title:"Fulfillment pulse",children:e.jsx(j.Section,{children:e.jsx(_,{columns:{xs:1,sm:2,md:3},gap:"200",children:a.map(([n,s,i])=>e.jsx(_.Cell,{children:e.jsxs(p,{gap:"050",children:[e.jsx(d,{as:"span",tone:"subdued",variant:"bodySm",children:n}),e.jsx(d,{as:"span",variant:"headingSm",children:s}),i&&e.jsx(N,{tone:i,children:"Action needed"})]})},n))})})})}function zt({shipments:t,onAddTracking:a,onTriggerFollowUp:n,actionState:s}){const i=s.isBusy&&s.intent==="markFulfilled",c=s.isBusy&&s.intent==="requestSupport";return e.jsxs(j,{title:"Shipments",children:[e.jsx(j.Section,{children:e.jsxs(p,{gap:"200",children:[e.jsxs(f,{align:"space-between",blockAlign:"center",children:[e.jsxs(d,{variant:"headingSm",as:"h3",children:["Tracking pending (",t.trackingPending.length,")"]}),e.jsxs(d,{tone:"subdued",variant:"bodySm",as:"span",children:["Delivered today: ",t.deliveredToday]})]}),t.trackingPending.length?e.jsx(p,{gap:"200",children:t.trackingPending.map(r=>e.jsxs(f,{align:"space-between",blockAlign:"center",wrap:!0,gap:"200",children:[e.jsxs(p,{gap:"050",children:[e.jsx(d,{variant:"bodyMd",fontWeight:"semibold",as:"span",children:r.orderNumber}),e.jsxs(d,{tone:"subdued",variant:"bodySm",as:"span",children:["Expected ",U(r.expectedShipDate)," · Owner ",he(r.owner)]})]}),e.jsx(I,{onClick:()=>a(r),disabled:i,loading:i,variant:"primary",children:"Add tracking"})]},r.id))}):e.jsx(d,{variant:"bodySm",children:"No tracking items pending."})]})}),e.jsx(z,{borderColor:"border"}),e.jsx(j.Section,{children:e.jsxs(p,{gap:"200",children:[e.jsxs(d,{variant:"headingSm",as:"h3",children:["Delayed (",t.delayed.length,")"]}),t.delayed.length?e.jsx(p,{gap:"200",children:t.delayed.map(r=>e.jsxs(f,{align:"space-between",blockAlign:"center",wrap:!0,gap:"200",children:[e.jsxs(p,{gap:"050",children:[e.jsx(d,{variant:"bodyMd",fontWeight:"semibold",as:"span",children:r.orderNumber}),e.jsxs(d,{tone:"subdued",variant:"bodySm",as:"span",children:[r.carrier," delay ",r.delayHours,"h · Last update ",te(r.lastUpdate)]})]}),e.jsx(I,{onClick:()=>n(r),disabled:c,loading:c,children:"Trigger follow-up"})]},r.id))}):e.jsx(d,{variant:"bodySm",children:"No carrier delays."})]})})]})}function Jt({returns:t,onHandleReturn:a,actionState:n}){const s=i=>n.isBusy&&n.intent===i;return e.jsxs(j,{title:"Returns & refunds",children:[e.jsx(j.Section,{children:e.jsxs(d,{variant:"bodySm",tone:"subdued",as:"span",children:["Refund exposure ",t.refundValue.formatted," • Pending approvals ",t.refundsDue]})}),e.jsx(j.Section,{children:t.pending.length?e.jsx(p,{gap:"200",children:t.pending.map(i=>e.jsx(p,{gap:"150",children:e.jsxs(f,{align:"space-between",blockAlign:"center",wrap:!0,gap:"200",children:[e.jsxs(p,{gap:"050",children:[e.jsx(d,{variant:"bodyMd",fontWeight:"semibold",as:"span",children:i.orderNumber}),e.jsxs(d,{tone:"subdued",variant:"bodySm",as:"span",children:["Stage ",i.stage.replace(/_/g," ")," · Reason ",i.reason," · Age ",i.ageDays.toFixed(1),"d"]})]}),e.jsxs(Ie,{children:[e.jsx(I,{variant:"primary",onClick:()=>a(i,"approve_refund"),loading:s("updateReturn"),disabled:s("updateReturn"),children:"Approve refund"}),e.jsx(I,{onClick:()=>a(i,"request_inspection"),loading:s("updateReturn"),disabled:s("updateReturn"),children:"Request inspection"}),e.jsx(I,{tone:"critical",onClick:()=>a(i,"deny"),loading:s("updateReturn"),disabled:s("updateReturn"),children:"Deny"})]})]})},i.id))}):e.jsx(d,{variant:"bodySm",children:"No returns pending."})})]})}function Vt({inventory:t,alerts:a}){return e.jsxs(j,{title:"Operational notes",children:[e.jsx(j.Section,{children:e.jsxs(p,{gap:"200",children:[e.jsx(d,{variant:"headingSm",as:"h3",children:"Inventory blocks"}),t.length?e.jsx(p,{gap:"200",children:t.map((n,s)=>e.jsxs(p,{gap:"150",children:[s>0?e.jsx(z,{borderColor:"border"}):null,e.jsxs(f,{align:"space-between",blockAlign:"start",gap:"200",wrap:!0,children:[e.jsxs(p,{gap:"100",children:[e.jsxs(p,{gap:"050",children:[e.jsxs(d,{variant:"bodyMd",fontWeight:"semibold",as:"span",children:[n.sku," — ",n.title]}),e.jsxs(f,{gap:"150",wrap:!0,children:[e.jsxs(N,{tone:Ft(n),children:[n.ordersWaiting," waiting"]}),e.jsxs(N,{tone:n.onHand>0?"info":"critical",children:[n.onHand," on hand"]}),e.jsxs(d,{tone:"subdued",variant:"bodySm",as:"span",children:["ETA ",U(n.eta)]})]})]}),e.jsx(d,{variant:"bodySm",as:"p",children:Ht(n)})]}),e.jsx(I,{variant:"plain",url:`/app/inventory?sku=${encodeURIComponent(n.sku)}`,children:"Review in inventory"})]})]},n.sku))}):e.jsx(d,{variant:"bodySm",children:"No inventory holds."})]})}),a.length>0&&e.jsxs(j.Section,{children:[e.jsx(d,{variant:"headingSm",as:"h3",children:"Alerts"}),e.jsx(p,{gap:"100",children:a.map((n,s)=>e.jsxs(d,{variant:"bodySm",children:["• ",n]},s))})]})]})}function Wt({order:t,onClose:a}){if(!t)return null;const n=t.lineItems.map(r=>[r.title,r.sku,`${r.quantity} × ${r.price.formatted}`,r.total.formatted]),s=n.length>0,i=t.tags.filter(Boolean),c=t.supportThread?`/app/inbox?conversation=${encodeURIComponent(t.supportThread)}`:null;return e.jsxs(E,{instant:!0,open:!0,onClose:a,title:`Order ${t.name}`,primaryAction:{content:"Close",onAction:a},children:[e.jsx(E.Section,{children:e.jsxs(p,{gap:"200",children:[e.jsxs(f,{align:"space-between",blockAlign:"center",children:[e.jsxs(p,{gap:"050",children:[e.jsx(d,{variant:"headingSm",as:"h3",children:t.name}),e.jsxs(d,{tone:"subdued",variant:"bodySm",as:"span",children:["Placed ",te(t.placedAt)," · ",t.channel.toUpperCase()]})]}),e.jsx(N,{tone:Re[t.priority],children:t.priority})]}),e.jsxs(_,{columns:{xs:1,sm:2},gap:"200",children:[e.jsx(_.Cell,{children:e.jsxs(p,{gap:"050",children:[e.jsx(d,{tone:"subdued",variant:"bodySm",as:"span",children:"Status"}),e.jsxs(f,{gap:"100",blockAlign:"center",children:[e.jsx(N,{tone:Et[t.status],children:t.status}),e.jsxs(N,{tone:Lt[t.fulfillmentStatus],children:["Fulfillment: ",t.fulfillmentStatus]})]})]})}),e.jsx(_.Cell,{children:e.jsxs(p,{gap:"050",children:[e.jsx(d,{tone:"subdued",variant:"bodySm",as:"span",children:"Issue"}),e.jsx(N,{tone:Mt[t.issue],children:t.issue==="none"?"No active issue":t.issue.replace(/_/g," ")})]})}),e.jsx(_.Cell,{children:e.jsxs(p,{gap:"050",children:[e.jsx(d,{tone:"subdued",variant:"bodySm",as:"span",children:"Owner"}),e.jsx(d,{variant:"bodyMd",as:"span",children:t.assignedTo??"unassigned"}),e.jsxs(d,{tone:"subdued",variant:"bodySm",as:"span",children:[t.ageHours.toFixed(1),"h in queue"]})]})}),e.jsx(_.Cell,{children:e.jsxs(p,{gap:"050",children:[e.jsx(d,{tone:"subdued",variant:"bodySm",as:"span",children:"Ship by"}),e.jsx(d,{variant:"bodyMd",as:"span",children:U(t.shipBy??t.fulfillmentDueAt)}),e.jsxs(d,{tone:"subdued",variant:"bodySm",as:"span",children:["Order value ",t.total.formatted]})]})})]}),i.length>0&&e.jsx(f,{gap:"100",children:i.map(r=>e.jsx(Ne,{children:r},r))})]})}),e.jsx(z,{borderColor:"border"}),e.jsx(E.Section,{children:e.jsxs(p,{gap:"200",children:[e.jsxs(f,{align:"space-between",blockAlign:"center",children:[e.jsx(d,{variant:"headingSm",as:"h3",children:"Customer"}),e.jsxs(d,{tone:"subdued",variant:"bodySm",as:"span",children:["Lifetime value ",t.customer.lifetimeValue.formatted]})]}),e.jsxs(p,{gap:"050",children:[e.jsx(d,{variant:"bodyMd",as:"span",children:t.customer.name}),e.jsx(d,{tone:"subdued",variant:"bodySm",as:"span",children:t.customer.email}),e.jsx(d,{tone:"subdued",variant:"bodySm",as:"span",children:t.customer.location})]}),e.jsxs(f,{gap:"200",children:[e.jsxs(d,{tone:"subdued",variant:"bodySm",as:"span",children:["First order ",U(t.customer.firstOrderAt)]}),e.jsxs(d,{tone:"subdued",variant:"bodySm",as:"span",children:["Last order ",U(t.customer.lastOrderAt)]})]})]})}),s&&e.jsxs(e.Fragment,{children:[e.jsx(z,{borderColor:"border"}),e.jsx(E.Section,{children:e.jsxs(p,{gap:"200",children:[e.jsxs(f,{align:"space-between",blockAlign:"center",children:[e.jsx(d,{variant:"headingSm",as:"h3",children:"Items"}),e.jsxs(d,{tone:"subdued",variant:"bodySm",as:"span",children:["Subtotal ",t.subtotal.formatted," · Shipping ",t.shipping.formatted]})]}),e.jsx(Nt,{columnContentTypes:["text","text","text","text"],headings:["Product","SKU","Qty × Price","Total"],rows:n})]})})]}),e.jsx(z,{borderColor:"border"}),e.jsx(E.Section,{children:e.jsxs(p,{gap:"200",children:[e.jsxs(f,{align:"space-between",blockAlign:"center",children:[e.jsx(d,{variant:"headingSm",as:"h3",children:"Fulfillment timeline"}),e.jsxs(p,{gap:"050",align:"start",children:[e.jsx(d,{tone:"subdued",variant:"bodySm",as:"span",children:"Support thread"}),t.supportThread&&c?e.jsx(I,{variant:"plain",url:c,accessibilityLabel:`Open support thread ${t.supportThread}`,children:t.supportThread}):e.jsx(d,{tone:"subdued",variant:"bodySm",as:"span",children:"Not linked"})]})]}),e.jsx(p,{gap:"100",children:t.timeline.length?t.timeline.map(r=>e.jsxs(p,{gap:"050",children:[e.jsx(d,{variant:"bodyMd",fontWeight:"semibold",as:"span",children:r.message}),e.jsx(d,{tone:"subdued",variant:"bodySm",as:"span",children:te(r.occurredAt)})]},r.id)):e.jsx(d,{tone:"subdued",variant:"bodySm",as:"span",children:"No events recorded yet."})})]})})]})}function Kt({baseOrders:t,submission:a,response:n}){const[s,i]=g.useState(t),c=g.useRef(null),r=g.useRef(null);return g.useEffect(()=>{i(t)},[t]),g.useEffect(()=>{if(!a||a===c.current)return;c.current=a;const u=a.formData.get("intent");if(typeof u!="string"||!u)return;const x=a.formData;i(T=>Zt({current:T,intent:u,formData:x}))},[a]),g.useEffect(()=>{if(!(!n||n===r.current)){if(r.current=n,n.success===!1){i(t);return}!Array.isArray(n.updatedOrders)||n.updatedOrders.length===0||i(u=>Qt(u,n.updatedOrders))}},[t,n]),g.useMemo(()=>{const u=new Map;return s.forEach(x=>{u.set(x.id,x)}),{orders:s,lookup:u}},[s])}function Zt({current:t,intent:a,formData:n}){switch(a){case"assign":{const s=we(n.get("orderIds"));if(!s.length)return t;const i=n.get("assignee"),c=typeof i=="string"&&i.trim().length?i.trim():"unassigned";return pe(t,s,r=>r.assignedTo===c?r:{...r,assignedTo:c})}case"markFulfilled":{const s=we(n.get("orderIds"));if(!s.length)return t;const i=fe(n.get("tracking")),c=new Date().toISOString();return pe(t,s,r=>{if(r.fulfillmentStatus==="fulfilled"&&r.status==="fulfilled")return r;const u=`${r.id}-optimistic-fulfill-${c}`,x=r.timeline.some(b=>b.id===u),T=["Marked fulfilled — awaiting Sync"];i!=null&&i.number&&T.push(`Tracking ${i.number}`);const v=x?r.timeline:[{id:u,type:"fulfillment",message:T.join(" · "),occurredAt:c,state:"fulfilled"},...r.timeline];return{...r,status:"fulfilled",fulfillmentStatus:"fulfilled",issue:"none",timeline:v}})}case"requestSupport":{const s=fe(n.get("payload")),i=Array.isArray(s==null?void 0:s.orderIds)?((s==null?void 0:s.orderIds)??[]).map(u=>String(u)):[];if(!i.length)return t;const c=typeof(s==null?void 0:s.note)=="string"?s.note.trim():"",r=new Date().toISOString();return pe(t,i,(u,x)=>{const T=u.supportThread??`conversation:${u.id}`,v=(s==null?void 0:s.conversationId)??T,b=`${u.id}-optimistic-support-${r}-${x}`,R=u.timeline.some(F=>F.id===b),M=c?`Support requested — ${c}`:"Support follow-up requested from dashboard.";return{...u,supportThread:v,timeline:R?u.timeline:[{id:b,type:"note",message:M,occurredAt:r},...u.timeline]}})}default:return t}}function pe(t,a,n){if(!a.length)return t;const s=new Set(a);let i=!1;const c=t.map((r,u)=>{if(!s.has(r.id))return r;const x=n(r,u);return x!==r&&(i=!0),x});return i?c:t}function Qt(t,a){if(!a.length)return t;const n=new Map;return a.forEach(s=>{s&&typeof s=="object"&&"id"in s&&typeof s.id=="string"&&n.set(s.id,s)}),n.size?t.map(s=>{const i=n.get(s.id);if(!i)return s;let c=s,r=!1;if("assignedTo"in i&&typeof i.assignedTo=="string"){const u=i.assignedTo.trim()||"unassigned";u!==s.assignedTo&&(c=r?{...c,assignedTo:u}:{...s,assignedTo:u},r=!0)}if("fulfillmentStatus"in i&&typeof i.fulfillmentStatus=="string"){const u=Yt(i.fulfillmentStatus);u&&u!==s.fulfillmentStatus&&(c=r?{...c}:{...s},c.fulfillmentStatus=u,u==="fulfilled"&&(c.status="fulfilled",c.issue="none"),r=!0)}return"supportThread"in i&&typeof i.supportThread=="string"&&i.supportThread&&i.supportThread!==s.supportThread&&(c=r?{...c,supportThread:i.supportThread}:{...s,supportThread:i.supportThread},r=!0),r?c:s}):t}function we(t){if(typeof t!="string")return[];const a=t.trim();if(!a)return[];const n=fe(a);return Array.isArray(n)?n.map(s=>String(s)).filter(s=>s.length>0):a.split(",").map(s=>s.trim()).filter(s=>s.length>0)}function fe(t){if(typeof t!="string")return null;try{return JSON.parse(t)}catch{return null}}function Yt(t){const a=t.toLowerCase();return a==="fulfilled"?"fulfilled":a==="partial"?"partial":a==="unfulfilled"?"unfulfilled":a==="in_transit"||a==="awaiting_tracking"?"partial":null}export{Ts as default};
