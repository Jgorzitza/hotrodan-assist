import{r as g,j as e}from"./index-DZoorY08.js";import{u as be,b as xe,c as ge,e as z}from"./components-CTA1UUXK.js";import{u as pe}from"./use-index-resource-state-7IuosbnD.js";import{P as je}from"./PolarisVizProvider-BMFajI3Y.js";import{P as fe,b as h,C as f,T as a,e as H,I as y,c as M,B as L,a as q,d as ye}from"./Page-CO1VPtMw.js";import{T as ve}from"./TitleBar-DFMSJ8Yc.js";import{B as R}from"./Banner-DCanv2aO.js";import{I as E}from"./InlineGrid-Bklo_vep.js";import{L as G}from"./Layout-Drv8ZkBJ.js";import{T as ke}from"./Tabs-DcbyKX5H.js";import{D as J}from"./Divider-DdX0k3iD.js";import{I as S}from"./IndexTable-nycHw1tK.js";import{M as X}from"./Modal-vYd8S7dQ.js";import{L as Se}from"./LineChart-DpGSaaOT.js";import{S as ne}from"./SparkLineChart-CQgKgDqj.js";import"./context-CVB7tZr2.js";import"./FormLayout-Cauguaew.js";import"./Checkbox-drAGhQ4I.js";import"./EmptySearchResult-D4D1_l9z.js";import"./AfterInitialMount-C-VclerA.js";import"./Sticky-3Wxpi6V4.js";import"./context-BSKof4BJ.js";import"./context-CdsfRJ3p.js";import"./SkipLink-CU7_6Q_C.js";import"./ChartContainer-DSIix7Zm.js";import"./LineSeries-CNDg3zjh.js";const Y=n=>{if(!Array.isArray(n)||n.length===0)return null;const d=n.map(m=>({label:m.label,units:Number.isFinite(m.units)?m.units:0})),c=Math.round(d.reduce((m,k)=>m+k.units,0)/d.length),v=d[d.length-1],p=d.length>1?d[d.length-2]:null,u=p&&p.units>0?Math.round((v.units-p.units)/p.units*100):null;let o=d[0],I=d[0];for(const m of d)m.units>o.units&&(o=m),m.units<I.units&&(I=m);return{average:c,latest:v,deltaPercentage:u,highest:o,lowest:I}},Ce=n=>{if(!Array.isArray(n)||n.length===0)return[];const d=n.map(u=>Array.isArray(u)?u.length:0),c=Math.max(0,...d);if(c===0)return[];const v=Array.from({length:c},()=>0),p=Array.from({length:c},()=>"");return n.forEach(u=>{Array.isArray(u)&&u.forEach((o,I)=>{const m=Number.isFinite(o==null?void 0:o.units)?o.units:0;v[I]+=m,!p[I]&&typeof(o==null?void 0:o.label)=="string"&&o.label.trim().length>0&&(p[I]=o.label)})}),v.map((u,o)=>({label:p[o]||`P${o+1}`,units:Math.round(u)}))},Ie=["urgent","air","sea","overstock"],Z={healthy:"success",low:"warning",backorder:"critical",preorder:"info"},we={low:"success",medium:"warning",high:"critical"},Me=n=>typeof n=="string"&&Ie.includes(n),ee=n=>new Intl.DateTimeFormat("en-US",{month:"short",day:"numeric"}).format(new Date(n)),l=n=>new Intl.NumberFormat("en-US").format(Math.round(n)),te=(n,d)=>new Intl.NumberFormat("en-US",{style:"currency",currency:d,minimumFractionDigits:2,maximumFractionDigits:2}).format(n);function nt(){var V,_;const{payload:n,useMockData:d,scenario:c,selectedBucket:v,count:p,mcp:u}=be(),[o]=xe(),I=ge(),m=z(),k=z(),[i,F]=g.useState(null),w=g.useMemo(()=>{const t=o.get("bucket");return Me(t)?t:v},[o,v]);g.useEffect(()=>{var t;if((t=k.data)!=null&&t.csv){const s=new Blob([k.data.csv],{type:"text/csv"}),r=document.createElement("a");r.href=URL.createObjectURL(s),r.download=k.data.filename??"inventory-export.csv",document.body.appendChild(r),r.click(),document.body.removeChild(r),setTimeout(()=>URL.revokeObjectURL(r.href),0)}},[k.data]);const[T,U]=g.useState(()=>{const t={};return n.vendors.forEach(s=>{s.items.forEach(r=>{t[r.skuId]=r.draftQuantity})}),t}),[B,O]=g.useState(()=>{const t={};return n.vendors.forEach(s=>{t[s.vendorId]=s.notes??""}),t});g.useEffect(()=>{const t={};n.vendors.forEach(r=>{r.items.forEach(j=>{t[j.skuId]=j.draftQuantity})}),U(t);const s={};n.vendors.forEach(r=>{s[r.vendorId]=r.notes??""}),O(s)},[n.vendors]);const $=g.useMemo(()=>{var t;return(t=i==null?void 0:i.trend)!=null&&t.length?[{name:"Weekly units",data:i.trend.map(s=>({key:s.label,value:Number.isFinite(s.units)?s.units:0}))}]:[]},[i]),x=g.useMemo(()=>i?Y(i.trend):null,[i]),P=g.useMemo(()=>n.skus.filter(t=>t.bucketId===w),[n.skus,w]),A=g.useMemo(()=>n.buckets.find(t=>t.id===w)??null,[n.buckets,w]),N=g.useMemo(()=>Ce(P.map(t=>t.trend)),[P]),Q=g.useMemo(()=>N.length===0?[]:[{name:"Bucket weekly units",data:N.map((t,s)=>({key:t.label||String(s),value:Number.isFinite(t.units)?t.units:0}))}],[N]),se=g.useMemo(()=>Y(N),[N]),W=g.useMemo(()=>n.buckets.map(t=>({id:t.id,content:t.label})),[n.buckets]),ae=Math.max(W.findIndex(t=>t.id===w),0),re=[{id:"skus-at-risk",label:"SKUs at risk",value:l(n.summary.skusAtRisk),tone:"critical"},{id:"average-cover",label:"Average cover",value:`${l(n.summary.averageCoverDays)} days`,tone:"info"},{id:"open-po",label:"Open PO budget",value:n.summary.openPoBudget.formatted,tone:"success"}],{selectedResources:K,allResourcesSelected:ie,handleSelectionChange:le}=pe(P),de=t=>{const s=n.buckets[t];if(!s)return;const r=new URLSearchParams(o);r.set("bucket",s.id),I(`?${r.toString()}`,{replace:!0})},oe=(t,s)=>{const r=Number(s);U(j=>({...j,[t]:Number.isFinite(r)?Math.max(Math.round(r),0):0}))},ce=t=>{const s=n.vendors.find(j=>j.vendorId===t);if(!s)return;const r={vendorId:t,notes:B[t],items:s.items.map(j=>({skuId:j.skuId,draftQuantity:T[j.skuId]??j.draftQuantity??0}))};m.submit({intent:"save-draft",payload:JSON.stringify(r)},{method:"post"})},ue=t=>{k.submit({intent:"export-csv",vendorId:t,count:String(p)},{method:"post"})},he=()=>{k.submit({intent:"export-csv",bucketId:w,count:String(p)},{method:"post"})};return e.jsx(je,{children:e.jsxs(fe,{title:"Inventory",subtitle:"Demand planning cockpit for replenishment, expediting, and overstock mitigation.",children:[e.jsx(ve,{title:"Inventory"}),e.jsxs(h,{gap:"400",children:[(d||n.alert||n.error)&&e.jsxs(h,{gap:"200",children:[d&&e.jsx(R,{tone:c==="warning"?"warning":"info",title:`Mock state: ${c}`,children:e.jsx("p",{children:"Append `?mockState=warning` (etc) to explore alternate datasets."})}),n.alert&&!n.error&&e.jsx(R,{tone:"warning",title:"Inventory alert",children:e.jsx("p",{children:n.alert})}),n.error&&e.jsx(R,{tone:"critical",title:"Inventory data unavailable",children:e.jsx("p",{children:n.error})})]}),e.jsx(E,{columns:{xs:1,md:3},gap:"300",children:re.map(t=>e.jsx(f,{children:e.jsx(f,{children:e.jsxs(h,{gap:"100",children:[e.jsx(a,{variant:"bodyMd",as:"span",children:t.label}),e.jsx(a,{variant:"headingLg",as:"span",children:t.value})]})})},t.id))}),e.jsx(f,{title:"MCP inventory signals",children:e.jsxs(h,{gap:"200",children:[u.signals.map(t=>e.jsx(H,{background:"bg-subdued",padding:"200",borderRadius:"200",children:e.jsxs(h,{gap:"150",children:[e.jsxs(y,{align:"space-between",blockAlign:"center",children:[e.jsxs(h,{gap:"050",children:[e.jsx(a,{variant:"bodyMd",as:"span",children:t.sku}),e.jsx(a,{variant:"bodySm",tone:"subdued",as:"span",children:t.suggestedAction})]}),e.jsx(M,{tone:we[t.riskLevel],children:t.riskLevel.toUpperCase()})]}),t.demandSignals.length>0&&e.jsx(y,{gap:"200",wrap:!0,children:t.demandSignals.map(s=>e.jsxs(M,{tone:"info",children:[s.label,": ",s.value,s.unit?`${s.unit}`:""]},s.label))})]})},t.sku)),u.signals.length===0&&e.jsx(a,{variant:"bodySm",tone:"subdued",as:"p",children:u.enabled?"No MCP inventory signals returned yet. Check back after the next sync.":"Enable the MCP integration in Settings to surface prioritized restock actions."}),u.generatedAt&&e.jsxs(a,{variant:"bodySm",tone:"subdued",as:"p",children:["Last updated ",new Date(u.generatedAt).toLocaleString()," â€¢ ",u.source??"mock"]}),u.usingMocks&&e.jsx(a,{variant:"bodySm",tone:"subdued",as:"p",children:"Showing mock MCP data while `USE_MOCK_DATA` is enabled."})]})}),e.jsx(G,{children:e.jsx(G.Section,{children:e.jsxs(f,{children:[e.jsx(f,{children:e.jsxs(y,{align:"space-between",blockAlign:"center",children:[e.jsx(ke,{tabs:W,selected:ae,onSelect:de,fitted:!0}),e.jsx(L,{onClick:he,loading:k.state!=="idle"&&((V=k.formData)==null?void 0:V.get("bucketId"))===w,children:"Export bucket CSV"})]})}),e.jsx(J,{}),e.jsx(f,{children:e.jsxs(h,{gap:"300",children:[(A==null?void 0:A.description)&&e.jsx(a,{variant:"bodySm",tone:"subdued",children:A.description}),P.length===0?e.jsx(h,{gap:"200",align:"center",children:e.jsx(a,{variant:"bodyMd",children:"No SKUs in this bucket yet."})}):e.jsxs(e.Fragment,{children:[Q.length>0?e.jsx(De,{bucketLabel:(A==null?void 0:A.label)??w,dataset:Q,stats:se}):e.jsx(a,{variant:"bodySm",tone:"subdued",children:"Demand trend data unavailable for this bucket."}),e.jsx(S,{resourceName:{singular:"SKU",plural:"SKUs"},itemCount:P.length,selectedItemsCount:ie?"All":K.length,onSelectionChange:le,headings:[{title:"SKU"},{title:"Vendor"},{title:"On hand"},{title:"Inbound"},{title:"Committed"},{title:"Cover (days)"},{title:"Trend (6w)"},{title:"Stockout"},{title:"Recommended"},{title:""}],children:P.map((t,s)=>e.jsxs(S.Row,{id:t.id,position:s,selected:K.includes(t.id),children:[e.jsx(S.Cell,{children:e.jsxs(h,{gap:"050",children:[e.jsx(a,{variant:"bodyMd",as:"span",children:t.title}),e.jsx(a,{tone:"subdued",variant:"bodySm",as:"span",children:t.sku})]})}),e.jsx(S.Cell,{children:e.jsx(a,{variant:"bodySm",as:"span",children:t.vendorName})}),e.jsx(S.Cell,{children:l(t.onHand)}),e.jsx(S.Cell,{children:l(t.inbound)}),e.jsx(S.Cell,{children:l(t.committed)}),e.jsx(S.Cell,{children:l(t.coverDays)}),e.jsx(S.Cell,{children:e.jsx(Ae,{skuTitle:t.title,trend:t.trend})}),e.jsx(S.Cell,{children:ee(t.stockoutDate)}),e.jsx(S.Cell,{children:l(t.recommendedOrder)}),e.jsx(S.Cell,{children:e.jsxs(y,{align:"end",gap:"200",children:[e.jsx(M,{tone:Z[t.status],children:t.status}),e.jsx(L,{onClick:()=>F(t),children:"View details"})]})})]},t.id))})]})]})})]})})}),e.jsxs(h,{gap:"300",children:[e.jsxs(y,{align:"space-between",blockAlign:"center",children:[e.jsx(a,{variant:"headingLg",as:"h2",children:"Purchase order planner"}),((_=m.data)==null?void 0:_.ok)&&e.jsx(M,{tone:"success",children:m.data.message})]}),n.vendors.length===0?e.jsx(f,{children:e.jsx(f,{children:e.jsx(a,{variant:"bodyMd",children:"No vendor drafts available yet."})})}):n.vendors.map(t=>{var r,j;const s=t.items.reduce((b,D)=>{const me=T[D.skuId]??D.draftQuantity;return b+me*D.unitCost.amount},0);return e.jsxs(f,{title:t.vendorName,children:[e.jsx(f,{children:e.jsxs(y,{gap:"400",children:[e.jsxs(a,{variant:"bodyMd",as:"span",children:["Lead time: ",t.leadTimeDays," days"]}),e.jsxs(a,{variant:"bodyMd",as:"span",children:["Budget: ",t.budgetRemaining.formatted]}),e.jsxs(a,{variant:"bodyMd",as:"span",children:["Draft total: ",te(s,t.budgetRemaining.currency)]})]})}),e.jsx(f,{children:e.jsx(h,{gap:"200",children:t.items.map(b=>e.jsx(H,{background:"bg-subdued",padding:"200",borderRadius:"200",children:e.jsxs(h,{gap:"150",children:[e.jsxs(y,{align:"space-between",blockAlign:"center",children:[e.jsxs(h,{gap:"050",children:[e.jsx(a,{variant:"bodyMd",as:"span",children:b.title}),e.jsx(a,{variant:"bodySm",tone:"subdued",as:"span",children:b.sku})]}),e.jsxs(M,{tone:"info",children:["Reco: ",l(b.recommendedOrder)]})]}),e.jsxs(y,{gap:"200",align:"space-between",blockAlign:"center",children:[e.jsx(q,{label:"Draft quantity",labelHidden:!0,type:"number",min:0,value:String(T[b.skuId]??b.draftQuantity),onChange:D=>oe(b.skuId,D)}),e.jsxs(a,{variant:"bodyMd",as:"span",children:["Unit cost: ",b.unitCost.formatted]}),e.jsxs(a,{variant:"bodyMd",as:"span",children:["Line total: ",te((T[b.skuId]??b.draftQuantity)*b.unitCost.amount,b.unitCost.currency)]})]})]})},b.skuId))})}),e.jsx(f,{subdued:!0,children:e.jsx(q,{label:"Planner notes",multiline:!0,value:B[t.vendorId],onChange:b=>O(D=>({...D,[t.vendorId]:b}))})}),e.jsx(f,{children:e.jsx(y,{align:"end",gap:"200",children:e.jsxs(ye,{children:[e.jsx(L,{onClick:()=>ce(t.vendorId),loading:m.state!=="idle"&&((r=m.formData)==null?void 0:r.get("payload"))!==void 0,primary:!0,children:"Save draft"}),e.jsx(L,{onClick:()=>ue(t.vendorId),loading:k.state!=="idle"&&((j=k.formData)==null?void 0:j.get("vendorId"))===t.vendorId,children:"Export vendor CSV"})]})})})]},t.vendorId)})]})]}),e.jsx(X,{open:i!==null,onClose:()=>F(null),title:(i==null?void 0:i.title)??"SKU details",children:i&&e.jsx(X.Section,{children:e.jsxs(h,{gap:"300",children:[e.jsxs(h,{gap:"100",children:[e.jsxs(a,{variant:"bodyMd",tone:"subdued",children:[i.sku," â€¢ ",i.vendorName]}),e.jsxs(y,{gap:"200",blockAlign:"center",children:[e.jsx(M,{tone:Z[i.status],children:i.status}),e.jsxs(a,{variant:"bodyMd",as:"span",children:["Bucket: ",i.bucketId]})]})]}),e.jsx(J,{}),e.jsxs(E,{columns:{xs:1,sm:2},gap:"200",children:[e.jsx(C,{label:"On hand",value:l(i.onHand)}),e.jsx(C,{label:"Inbound",value:l(i.inbound)}),e.jsx(C,{label:"Committed",value:l(i.committed)}),e.jsx(C,{label:"Coverage",value:`${l(i.coverDays)} days`}),e.jsx(C,{label:"Reorder point",value:l(i.reorderPoint)}),e.jsx(C,{label:"Safety stock",value:l(i.safetyStock)}),e.jsx(C,{label:"Stockout date",value:ee(i.stockoutDate)}),e.jsx(C,{label:"Recommended order",value:l(i.recommendedOrder)})]}),e.jsxs(h,{gap:"200",children:[e.jsxs(y,{align:"space-between",blockAlign:"center",children:[e.jsx(a,{variant:"headingSm",as:"h3",children:"Demand trend"}),(x==null?void 0:x.deltaPercentage)!==null&&e.jsxs(M,{tone:x.deltaPercentage>=0?"success":"critical",children:[x.deltaPercentage>=0?"+":"",x.deltaPercentage,"% WoW"]})]}),$.length?e.jsx("div",{style:{width:"100%",height:240},children:e.jsx(Se,{data:$,isAnimated:!1,xAxisOptions:{hide:!0},tooltipOptions:{keyFormatter:t=>String(t??""),valueFormatter:t=>{const s=typeof t=="number"?t:Number(t??0),r=Number.isFinite(s)?s:0;return`${l(r)} units`}},yAxisOptions:{labelFormatter:t=>{const s=typeof t=="number"?t:Number(t??0),r=Number.isFinite(s)?s:0;return l(r)}}})}):e.jsx(a,{variant:"bodySm",tone:"subdued",children:"Demand trend data unavailable."}),x&&e.jsxs(E,{columns:{xs:1,sm:3},gap:"200",children:[e.jsx(C,{label:`Latest (${x.latest.label})`,value:`${l(x.latest.units)} units`}),e.jsx(C,{label:"6-week average",value:`${l(x.average)} units`}),e.jsx(C,{label:`Range (${x.lowest.label}-${x.highest.label})`,value:`${l(x.lowest.units)}-${l(x.highest.units)} units`})]}),d&&e.jsx(a,{variant:"bodySm",tone:"subdued",children:"Showing mock demand history. Live Shopify analytics will populate this chart once connected."})]})]})})})]})})}function Ae({trend:n,skuTitle:d}){if(!n.length)return e.jsx(a,{variant:"bodySm",tone:"subdued",as:"span",children:"--"});const c=n.map((u,o)=>({key:o,value:Number.isFinite(u.units)?u.units:0})),v=n[n.length-1],p=Number.isFinite(v.units)?v.units:0;return e.jsxs(h,{gap:"050",children:[e.jsx("div",{style:{width:"100%",minWidth:120,height:60},children:e.jsx(ne,{data:[{name:"Weekly units",data:c}],isAnimated:!1,accessibilityLabel:`Weekly units sold for ${d}`})}),e.jsxs(a,{variant:"bodySm",tone:"subdued",as:"span",children:[v.label,": ",l(p)]})]})}function C({label:n,value:d}){return e.jsxs(h,{gap:"050",children:[e.jsx(a,{variant:"bodySm",tone:"subdued",as:"span",children:n}),e.jsx(a,{variant:"bodyMd",as:"span",children:d})]})}function De({bucketLabel:n,dataset:d,stats:c}){return d.length?e.jsxs(y,{align:"space-between",blockAlign:"center",gap:"300",wrap:!0,children:[e.jsx("div",{style:{flex:"1 1 240px",minWidth:220,maxWidth:360,height:100},children:e.jsx(ne,{data:d,isAnimated:!1,accessibilityLabel:`Weekly units sold across ${n} bucket`})}),c&&e.jsxs(h,{gap:"050",align:"end",children:[e.jsxs(y,{gap:"200",blockAlign:"center",children:[e.jsxs(a,{variant:"bodyMd",as:"span",children:["Last week: ",l(c.latest.units)," units"]}),c.deltaPercentage!==null&&e.jsxs(M,{tone:c.deltaPercentage>=0?"success":"critical",children:[c.deltaPercentage>=0?"+":"",c.deltaPercentage,"% WoW"]})]}),e.jsxs(a,{variant:"bodySm",tone:"subdued",as:"span",children:["Avg ",l(c.average)," units â€¢ Range ",l(c.lowest.units),"-",l(c.highest.units)," units"]})]})]}):null}export{nt as default};
