import{r as i,j as e}from"./index-DZoorY08.js";import{b as ge,D as je}from"./date-range-CLhjUUo2.js";import{u as ve,b as fe,c as be,e as ae,f as ye}from"./components-CTA1UUXK.js";import{L as w}from"./Link-BWGL7uAm.js";import{c as re,P as Se,b as u,C as o,I as f,d as Re,B as se,T as s}from"./Page-CO1VPtMw.js";import{P as ke}from"./PolarisVizProvider-BMFajI3Y.js";import{T as Ie}from"./TitleBar-DFMSJ8Yc.js";import{B as F}from"./Banner-DCanv2aO.js";import{S as oe}from"./Select-BzpuXWta.js";import{I as S}from"./InlineGrid-Bklo_vep.js";import{D as g}from"./DataTable-DOlFJz1k.js";import{L as m}from"./Layout-Drv8ZkBJ.js";import{S as Te}from"./SparkLineChart-CQgKgDqj.js";import{B as we}from"./BarChart-BTH-R0IZ.js";import"./context-CVB7tZr2.js";import"./index-1GQyLQny.js";import"./AfterInitialMount-C-VclerA.js";import"./Sticky-3Wxpi6V4.js";import"./ChartContainer-DSIix7Zm.js";import"./LineSeries-CNDg3zjh.js";import"./SkipLink-CU7_6Q_C.js";const Ce=[{label:"Daily",value:"daily"},{label:"Weekly",value:"weekly"},{label:"Monthly",value:"monthly"}],De="28d",Me=n=>{switch(n){case"today":return"7d";case"7d":case"14d":case"28d":case"90d":return n;default:return De}},Ae=n=>{switch(n){case"14d":return"14d";case"7d":case"28d":case"90d":return n;default:return je}},Fe=[{label:"Previous period",value:"previous_period"},{label:"Previous year",value:"previous_year"}],C=(n,h=1)=>`${n>=0?"+":""}${n.toFixed(h)}%`,P=n=>new Intl.DateTimeFormat("en-US",{month:"short",day:"numeric"}).format(new Date(n));function tt(){var J;const{dataset:n,scenario:h,useMockData:R,filters:l,drilldown:c,selection:O}=ve(),[$]=fe(),b=be(),k=ae(),le=ae(),ie=ye(),{load:B}=le,j=k.data,N=i.useRef(null),U=i.useRef(new Set),E=ie.pathname||"/app/sales",v=i.useCallback(t=>{if(!t)return;const r=t.startsWith("?")?`${E}${t}`:t;U.current.has(r)||(U.current.add(r),B(r))},[E,B]),x=i.useMemo(()=>t=>{const r=new URLSearchParams,a=$.get("mockState");a&&r.set("mockState",a);const d=t.period??l.period;r.set("period",d);const T=(t.range===void 0?l.range:t.range??l.range)??Ae(d);r.set("range",T),r.set("compare",t.compare??l.compare),r.set("granularity",t.granularity??l.granularity);const X=t.bucketDate===void 0?l.bucketDate:t.bucketDate;X&&r.set("bucketDate",X);const Z=t.collectionId===void 0?l.collectionId:t.collectionId;Z&&r.set("collectionId",Z);const ee=t.productId===void 0?l.productId:t.productId;ee&&r.set("productId",ee);const te=t.variantId===void 0?l.variantId:t.variantId;te&&r.set("variantId",te);const ne=r.toString();return ne?`?${ne}`:""},[l,$]);k.state,i.useEffect(()=>{if(k.state==="idle"&&typeof j=="string"&&j.length>0&&N.current!==j){N.current=j;const t=new Blob([j],{type:"text/csv;charset=utf-8"}),r=URL.createObjectURL(t),a=document.createElement("a");a.href=r,a.download=`sales-${c.level}-${l.period}.csv`,a.click(),URL.revokeObjectURL(r)}},[k.state,j,c.level,l.period]);const ce=t=>{const r=x({granularity:t,collectionId:null,productId:null,variantId:null});b(r||".",{replace:!0})},de=t=>{const r=x({period:Me(t),range:t,bucketDate:null,collectionId:null,productId:null,variantId:null});b(r||".",{replace:!0})},ue=t=>{const r=x({compare:t});b(r||".",{replace:!0})},he=()=>{const t=x({collectionId:null,productId:null,variantId:null});b(t||".",{replace:!0})},G=i.useMemo(()=>new Intl.NumberFormat("en-US",{style:"currency",currency:n.totals.currentTotal.currency,minimumFractionDigits:2,maximumFractionDigits:2}),[n.totals.currentTotal.currency]),A=i.useCallback(t=>{const r=typeof t=="number"?t:Number(typeof t=="string"&&t.trim().length?t:t??0),a=Number.isFinite(r)?r:0;return G.format(a)},[G]),V=i.useMemo(()=>n.trend.length?[{name:"GMV",data:n.trend.map(t=>({key:t.date,value:t.total.amount}))}]:[],[n.trend]),y=i.useMemo(()=>n.channelBreakdown.map(t=>({key:t.channel,value:t.total.amount})),[n.channelBreakdown]),_=i.useMemo(()=>y.length?[{name:"Revenue",data:y}]:[],[y]),me=i.useMemo(()=>Math.max(160,y.length*44),[y]),I=i.useMemo(()=>{switch(c.level){case"collections":{const t=c.rows.map(a=>{const d=c.nextLevel?x({collectionId:a.id,productId:null,variantId:null}):"";return[c.nextLevel?e.jsx(w,{url:d,onMouseEnter:()=>v(d),onFocus:()=>v(d),onTouchStart:()=>v(d),children:a.title}):a.title,a.gmv.formatted,p(a.orders),`${a.conversionRate.toFixed(2)}%`,`${a.returningRate.toFixed(1)}%`,`${a.attachRate.toFixed(1)}%`,C(a.deltaPercentage)]});return{headings:["Collection","GMV","Orders","Conversion","Returning","Attach","Δ"],rows:t,columnTypes:["text","numeric","numeric","text","text","text","text"]}}case"products":{const t=c.rows.map(a=>{const d=c.nextLevel?x({productId:a.id,variantId:null}):"";return[c.nextLevel?e.jsx(w,{url:d,onMouseEnter:()=>v(d),onFocus:()=>v(d),onTouchStart:()=>v(d),children:a.title}):a.title,a.gmv.formatted,p(a.orders),`${a.attachRate.toFixed(1)}%`,`${a.returningRate.toFixed(1)}%`,`${a.refundRate.toFixed(1)}%`,L(a.inventoryStatus)]});return{headings:["Product","GMV","Orders","Attach","Returning","Refund","Inventory"],rows:t,columnTypes:["text","numeric","numeric","text","text","text","text"]}}case"variants":{const t=c.rows.map(a=>[a.title,a.sku,a.gmv.formatted,p(a.unitsSold),`${a.attachRate.toFixed(1)}%`,p(a.inventoryOnHand),L(a.backorderRisk)]);return{headings:["Variant","SKU","GMV","Units","Attach","On hand","Backorder risk"],rows:t,columnTypes:["text","text","numeric","numeric","text","numeric","text"]}}default:return{headings:[],rows:[],columnTypes:[]}}},[c,x]),H=i.useMemo(()=>n.trend.map(t=>{var T;const r=x({bucketDate:t.date,collectionId:null,productId:null,variantId:null}),a=P(t.date),d=((T=O.bucket)==null?void 0:T.date)===t.date,Q=r||".";return[e.jsx(w,{url:Q,children:d?e.jsx(re,{tone:"info",children:a}):a},t.date),t.total.formatted,p(t.orders)]}),[n.trend,x,O.bucket]),K=i.useMemo(()=>n.bestSellers.slice(0,5).map(t=>[t.title,t.gmv.formatted,p(t.orders),`${t.attachRate.toFixed(1)}%`]),[n.bestSellers]),q=i.useMemo(()=>n.laggards.slice(0,5).map(t=>[t.title,t.gmv.formatted,p(t.orders),`${t.attachRate.toFixed(1)}%`]),[n.laggards]),Y=i.useMemo(()=>n.attachRateInsights.slice(0,4).map(t=>[`${t.primaryProduct} → ${t.attachmentProduct}`,`${t.attachRate.toFixed(1)}%`,t.opportunity]),[n.attachRateInsights]),z=i.useMemo(()=>n.overstockRisks.slice(0,4).map(t=>[t.title,L(t.status),`${t.daysOnHand} days`,t.recommendedAction]),[n.overstockRisks]),W=i.useMemo(()=>n.topCustomers.slice(0,5).map(t=>[t.name,p(t.orders),t.lifetimeValue.formatted,Pe(t.lastOrderAt)]),[n.topCustomers]),xe=c.level==="variants"?"Units sold":"Orders",pe=!!(l.collectionId||l.productId||l.variantId);return e.jsx(ke,{children:e.jsxs(Se,{title:"Sales analytics",subtitle:"Inspect revenue trends, channel performance, and forecast variance.",children:[e.jsx(Ie,{title:"Sales"}),e.jsxs(u,{gap:"500",children:[(n.alert||n.error||R)&&e.jsxs(u,{gap:"200",children:[R&&e.jsx(F,{title:`Mock data scenario: ${h}`,tone:h==="warning"?"warning":"info",children:e.jsx("p",{children:"Adjust the `mockState` query parameter to preview alternate data states."})}),n.alert&&!n.error&&e.jsx(F,{tone:"warning",title:"Attention required",children:e.jsx("p",{children:n.alert})}),n.error&&e.jsx(F,{tone:"critical",title:"Sales data unavailable",children:e.jsx("p",{children:n.error})})]}),e.jsxs(o,{children:[e.jsx(o,{title:"Revenue summary",actions:[{content:"Refresh",onAction:()=>b(0)}]}),e.jsx(o,{children:e.jsxs(f,{align:"space-between",blockAlign:"center",children:[e.jsxs(f,{gap:"200",children:[e.jsx(oe,{labelHidden:!0,label:"Granularity",options:Ce,value:l.granularity,onChange:ce}),e.jsx(Re,{children:ge.map(t=>e.jsx(se,{pressed:l.range===t,onClick:()=>de(t),children:t==="today"?"TODAY":t.toUpperCase()},t))}),e.jsx(oe,{labelHidden:!0,label:"Comparison",options:Fe,value:l.compare,onChange:ue})]}),e.jsx(re,{tone:n.forecast?"attention":"info",children:n.range.label})]})}),e.jsx(o,{children:e.jsxs(S,{columns:{xs:1,sm:2,lg:4},gap:"300",children:[e.jsx(M,{label:"Current revenue",value:n.totals.currentTotal.formatted,delta:C(n.totals.deltaPercentage)}),e.jsx(M,{label:"Previous period",value:n.totals.previousTotal.formatted,delta:"Benchmark"}),e.jsx(M,{label:"Average order value",value:n.totals.averageOrderValue.formatted,delta:`Conversion ${n.totals.conversionRate.toFixed(2)}%`}),e.jsx(M,{label:"Forecast variance",value:((J=n.forecast)==null?void 0:J.projectedTotal.formatted)??n.totals.currentTotal.formatted,delta:n.forecast?`${C(n.forecast.variancePercentage)} ${n.forecast.varianceLabel.replace("_"," ")}`:"On track"})]})})]}),e.jsxs(o,{title:"Performance drilldown",children:[e.jsx(o,{children:e.jsxs(f,{align:"space-between",blockAlign:"center",wrap:!0,children:[e.jsx(f,{gap:"200",wrap:!0,children:c.breadcrumbs.map((t,r)=>e.jsxs(f,{gap:"100",blockAlign:"center",children:[r>0&&e.jsx(s,{as:"span",tone:"subdued",children:"›"}),t.href?e.jsx(w,{url:t.href,children:t.label}):e.jsx(s,{as:"span",variant:"bodyMd",children:t.label})]},`${t.label}-${r}`))}),pe&&e.jsx(se,{onClick:he,variant:"plain",children:"Reset drilldown"})]})}),e.jsx(o,{children:e.jsxs(S,{columns:{xs:1,sm:2,lg:4},gap:"300",children:[e.jsx(D,{label:"GMV",value:c.metrics.gmv.formatted}),e.jsx(D,{label:xe,value:p(c.metrics.orders)}),e.jsx(D,{label:"Attach rate",value:`${c.metrics.attachRate.toFixed(1)}%`}),e.jsx(D,{label:"Returning rate",value:`${c.metrics.returningRate.toFixed(1)}%`})]})}),e.jsx(o,{children:I.rows.length?e.jsx(g,{columnContentTypes:I.columnTypes,headings:I.headings,rows:I.rows}):e.jsx(s,{tone:"subdued",variant:"bodySm",children:"No data available for this selection."})})]}),e.jsxs(m,{children:[e.jsx(m.Section,{children:e.jsxs(o,{title:"Revenue trend",children:[e.jsx(o,{children:V.length?e.jsx("div",{style:{width:"100%",height:220},children:e.jsx(Te,{data:V,isAnimated:!1,accessibilityLabel:"Revenue trend for the selected period",tooltipOptions:{valueFormatter:t=>A(t),keyFormatter:t=>P(String(t??"")),titleFormatter:t=>P(String(t??""))}})}):e.jsx(s,{tone:"subdued",variant:"bodySm",children:"Revenue trend data unavailable."})}),e.jsx(o,{children:H.length?e.jsx(g,{columnContentTypes:["text","text","numeric"],headings:["Date","GMV","Orders"],rows:H}):e.jsx(s,{tone:"subdued",variant:"bodySm",children:"No revenue entries for this period."})})]})}),e.jsx(m.Section,{secondary:!0,children:e.jsxs(o,{title:"Channel breakdown",children:[e.jsx(o,{children:_.length?e.jsx("div",{style:{width:"100%",height:me},children:e.jsx(we,{data:_,direction:"horizontal",isAnimated:!1,showLegend:!1,skipLinkText:"Skip channel breakdown chart",tooltipOptions:{valueFormatter:t=>A(t),keyFormatter:t=>String(t??"")},xAxisOptions:{labelFormatter:t=>A(t)}})}):e.jsx(s,{tone:"subdued",variant:"bodySm",children:"No channel data available."})}),n.channelBreakdown.length?e.jsx(o,{children:e.jsx(u,{gap:"300",children:n.channelBreakdown.map(t=>e.jsxs(f,{align:"space-between",blockAlign:"center",children:[e.jsxs(u,{gap:"050",children:[e.jsx(s,{as:"span",variant:"bodyMd",children:t.channel}),e.jsxs(s,{as:"span",variant:"bodySm",tone:"subdued",children:[C(t.percentage,1)," of revenue"]})]}),e.jsx(s,{variant:"headingMd",as:"span",children:t.total.formatted})]},t.channel))})}):null]})})]}),e.jsx(m,{children:e.jsx(m.Section,{children:e.jsx(o,{title:"Product performance",sectioned:!0,children:e.jsxs(S,{columns:{xs:1,lg:2},gap:"400",children:[e.jsxs(u,{gap:"200",children:[e.jsx(s,{as:"h3",variant:"headingSm",children:"Best sellers"}),K.length?e.jsx(g,{columnContentTypes:["text","text","numeric","text"],headings:["Product","GMV","Orders","Attach"],rows:K}):e.jsx(s,{tone:"subdued",variant:"bodySm",children:"No best sellers to show."})]}),e.jsxs(u,{gap:"200",children:[e.jsx(s,{as:"h3",variant:"headingSm",children:"Laggards"}),q.length?e.jsx(g,{columnContentTypes:["text","text","numeric","text"],headings:["Product","GMV","Orders","Attach"],rows:q}):e.jsx(s,{tone:"subdued",variant:"bodySm",children:"No laggards detected."})]})]})})})}),e.jsx(m,{children:e.jsx(m.Section,{children:e.jsx(o,{title:"Attach & inventory insights",sectioned:!0,children:e.jsxs(S,{columns:{xs:1,lg:2},gap:"400",children:[e.jsxs(u,{gap:"200",children:[e.jsx(s,{as:"h3",variant:"headingSm",children:"Attach opportunities"}),Y.length?e.jsx(g,{columnContentTypes:["text","text","text"],headings:["Bundle","Attach","Opportunity"],rows:Y}):e.jsx(s,{tone:"subdued",variant:"bodySm",children:"No attach-rate insights available."})]}),e.jsxs(u,{gap:"200",children:[e.jsx(s,{as:"h3",variant:"headingSm",children:"Inventory risks"}),z.length?e.jsx(g,{columnContentTypes:["text","text","text","text"],headings:["Product","Status","Days on hand","Recommendation"],rows:z}):e.jsx(s,{tone:"subdued",variant:"bodySm",children:"Inventory is healthy."})]})]})})})}),e.jsxs(m,{children:[e.jsx(m.Section,{children:e.jsx(o,{title:"Customer cohorts",sectioned:!0,children:e.jsx(S,{columns:{xs:1,sm:3},gap:"400",children:n.cohortHighlights.map(t=>e.jsxs(u,{gap:"100",children:[e.jsx(s,{as:"span",variant:"bodySm",tone:"subdued",children:t.title}),e.jsx(s,{as:"span",variant:"headingMd",children:t.value}),e.jsx(s,{as:"p",variant:"bodySm",tone:"subdued",children:t.description})]},t.id))})})}),e.jsx(m.Section,{secondary:!0,children:e.jsx(o,{title:"Top customers",sectioned:!0,children:W.length?e.jsx(g,{columnContentTypes:["text","numeric","text","text"],headings:["Customer","Orders","Lifetime value","Last order"],rows:W}):e.jsx(s,{tone:"subdued",variant:"bodySm",children:"No customer insights yet."})})})]})]})]})})}function D({label:n,value:h}){return e.jsxs(u,{gap:"050",children:[e.jsx(s,{as:"span",variant:"bodySm",tone:"subdued",children:n}),e.jsx(s,{as:"span",variant:"headingMd",children:h})]})}const p=n=>n.toLocaleString("en-US"),L=n=>n.replace(/_/g," ").replace(/\b\w/g,h=>h.toUpperCase()),Pe=n=>new Intl.DateTimeFormat("en-US",{month:"short",day:"numeric",year:"numeric"}).format(new Date(n));function M({label:n,value:h,delta:R}){return e.jsx(o,{background:"bg-surface-secondary",children:e.jsx(o,{children:e.jsxs(u,{gap:"050",children:[e.jsx(s,{as:"span",variant:"bodySm",tone:"subdued",children:n}),e.jsx(s,{as:"p",variant:"headingLg",children:h}),e.jsx(s,{as:"span",variant:"bodySm",tone:"subdued",children:R})]})})})}export{tt as default};
