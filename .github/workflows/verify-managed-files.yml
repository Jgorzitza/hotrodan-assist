name: verify-managed-files
on: [pull_request]
jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - name: Block non-manager edits to managed files
        run: |
          MANAGED='^(docs/agents\.md|handover/|coordination/agent-feedback-guidelines\.md|agent/.*/INSTRUCTIONS\.md|coordination/registry/|coordination/templates/|coordination/digests/)'
          AUTHOR="$(git log -1 --pretty=%an)"
          if git diff --name-only origin/${{ github.base_ref }}... | grep -E "$MANAGED" >/dev/null; then
            echo "Author: $AUTHOR"
            if ! echo "$AUTHOR" | grep -qi "manager"; then
              echo "‚ùå Non-manager attempted to modify managed files."
              exit 1
            fi
          fi
      - name: Validate generated headers
        run: |
          bad=$(grep -L "GENERATED BY manager. DO NOT EDIT." -R docs/agents.md handover coordination -n || true)
          test -z "$bad" || { echo "Missing generated headers:\n$bad"; exit 1; }
