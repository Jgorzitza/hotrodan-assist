# 2025-09-27 SEO Agent Notes

## Updates
- Collected GA4/GSC/Bing payloads in `app/routes/app.seo.tsx` now resolve via `Promise.all` so loader fetches run in parallel; lint (`npx eslint app/routes/app.seo.tsx`) and Prisma loader test (`npx vitest run app/routes/__tests__/app.seo.prisma.test.ts`) are green.
- Added `app/routes/__tests__/app.seo.loader.test.ts` to cover concurrent loader fetches and adapter fallback (`npx vitest run app/routes/__tests__/app.seo.loader.test.ts`).
- Persisting action status/assignee/due date now runs through Prisma `SeoInsight` upsert; loader merges overrides.
- Verified lint (`npx eslint app/routes/app.seo.tsx`) and vitest coverage for SEO persistence/loader (`npx vitest run app/lib/seo/__tests__/persistence.server.test.ts app/routes/__tests__/app.seo.prisma.test.ts`).
- Branched `feature/seo-adapter-msw` and landed shared MSW handlers + Vitest coverage for GA4/GSC/Bing adapter traffic (`npx vitest run app/tests/msw/seo-handlers.test.ts`).

## Adapter Swap Playbook (draft)
- Credential intake: confirm GA4/GSC/Bing API tokens land in Settings secrets (`StoreSecret` rows) with rotation reminders before we toggle live adapters.
- Client implementation: add real GA4 Analytics Data, GSC Search Console, and Bing Webmaster clients behind `create*Client` factories with per-store credentials and 429 retry handling.
- Settings dependencies: extend `storeSettingsRepository` to hydrate `connections` from live health pings and expose enable/disable toggles in `route-settings` so loader copy can show fallback states.
- QA + rollout: stage on dev with mock toggles flipped off, record connection history, then progress to staging and prod with feature flag + metrics review; retain `USE_MOCK_DATA` override for rollback.
- Observability: pipe adapter errors through `ConnectionEvent` logging, surface alerts in dashboard banner, and capture latency, quota, and error codes in the analytics feed.

## Prisma Action Status Migration Checklist (draft)
- Schema readiness: ensure `SeoInsight` migrations run against production Postgres and indexes on `(storeId,status,severity)` / `(storeId,detectedAt)` stay in place.
- Backfill strategy: seed existing mock actions into Prisma with `pending` statuses before enabling write path so users keep continuity.
- App wiring: gate `persistSeoActionUpdate` behind feature flag per store, verify Prisma connection pooling, and confirm retries map non-fatal errors to UI toasts.
- Data hygiene: schedule retention job (e.g., 12-month purge of resolved insights) and capture audit log entries for status/assignee changes.
- Validation: expand Vitest Prisma integration suite to cover assign/unassign/due date permutations and run smoke in staging prior to GA rollout.

## MSW Harness
- Base harness serves GA4 summary/trend, GSC keywords/actions/coverage, and Bing page metrics off `https://seo.adapters.test` with scenario + outage toggles.
- Scenario switcher supports latency overrides and rate limit/offline/error simulations per adapter for integration tests.
- Vitest coverage validates success, empty scenario, and offline responses; next up is to plug the harness into Remix loader tests once live clients are ready.

## Next
- Await Settings agent response on secret intake UX and document any UI/API changes needed on SEO route.
- Integrate the MSW harness into SEO loader integration tests once live adapter clients land; sketch env plumbing (`SEO_ADAPTER_BASE_URL`) ahead of implementation.
