# 2025-10-09 Data Agent Notes

## Updates
- Added Prisma retention sweep for `KpiCache`: new helper prunes expired datasets (TTL + fallback window) and `/cron/retention` now logs cache deletes alongside connection event + secret stats.
- Updated Prisma seed cache entry to mirror the new `fetchSalesAnalyticsWithCache` contract: uses hashed `sales_analytics:*` metric key, normalized search payload, and wrapped dataset with stored timestamp so Remix loaders hit a warm cache out of the box.
- Seed now reuses the analytics fixtures via `mapAnalyticsResponse`, keeping the persisted dataset in sync with the live Sales adapter shape (range values align with the shared dashboard range helper).
- Revalidated Prisma generate/db push/seed and retention test suite after the KPI cache persistence changes; latest run 2025-10-09 18:33 local.

## Tests
- `npm exec vitest run app/lib/settings/__tests__/retention.server.test.ts`
- `npm run prisma:generate`
- `DATABASE_URL="file:./prisma/dev.sqlite" npm run prisma:db-push:sqlite`
- `DATABASE_URL="file:./prisma/dev.sqlite" npm run prisma:seed`

## Next
- Hold for Ops decision on staging cron hosting (Fly vs Render) before wiring `/cron/retention` in deploy docs; rerun retention Vitest once staging picks up the migration and confirm the job logs the new KPI cache purge stats end-to-end.
- Coordinate with Sales to validate cache hit/miss behaviour once analytics service goes live and document invalidation flow if additional routes start persisting KPI datasets.
